# In wrangler.toml

# A user-friendly name for the Worker service.
name = "storybook-deployment-service"

# The entry point file for the Worker.
main = "src/entry.worker.ts"

# Specifies the version of the Workers runtime APIs to use.
# Updated to 2024-09-23 for automatic Node.js built-in module resolution
compatibility_date = "2024-09-23"

# Enable Node.js compatibility for packages like 'stream'
compatibility_flags = ["nodejs_compat"]

# Development server configuration
[dev]
ip = "0.0.0.0"  # Bind to all network interfaces instead of just localhost
port = 8787

# Defines the bindings to other Cloudflare resources.
[[r2_buckets]]
# The variable name used to access the binding in the code (c.env.STORYBOOK_BUCKET).
binding = "STORYBOOK_BUCKET"
# The name of the actual R2 bucket in the Cloudflare dashboard.
bucket_name = "my-storybooks-production"
# For local development, a preview bucket can be specified.
preview_bucket_name = "my-storybooks-staging"

# --- Environment Variables and Secrets ---
# The following variables are required for the S3-compatible API to work.
# For local development with `wrangler dev`, you can define them in this `.dev.vars` file.
# For production, you must set these as secrets using the `wrangler secret put` command.
# Example: `wrangler secret put R2_ACCOUNT_ID`

[vars]
# Non-sensitive configuration values
# NOTE: R2_ACCOUNT_ID is set via secrets for security (even though it's not highly sensitive)
R2_BUCKET_NAME = "my-storybooks-production"

# IMPORTANT: The following secrets MUST be set via `wrangler secret put`:
# - R2_ACCOUNT_ID (your Cloudflare account ID)
# - R2_S3_ACCESS_KEY_ID (32-character access key ID)
# - R2_S3_SECRET_ACCESS_KEY (secret access key)
# - FIREBASE_PROJECT_ID
# - FIREBASE_CLIENT_EMAIL
# - FIREBASE_PRIVATE_KEY
# - SENTRY_DSN (Sentry Data Source Name for error tracking)
#
# DO NOT add placeholder values here - they will override secrets!

# Preview environment for PR deployments
[env.preview]
name = "storybook-deployment-service-preview"
vars = { R2_BUCKET_NAME = "my-storybooks-staging" }

[[env.preview.r2_buckets]]
binding = "STORYBOOK_BUCKET"
bucket_name = "my-storybooks-staging"
preview_bucket_name = "my-storybooks-staging"

# Observability and Logging Configuration
[observability]
[observability.logs]
enabled = true  # Enable logging
head_sampling_rate = 1  # Sample 100% of requests
invocation_logs = true  # Log function invocations
persist = true  # Persist logs for analysis
